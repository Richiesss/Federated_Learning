# Federated Learning Segmentation System

## 概要

このシステムは、医療画像のセグメンテーションタスクにおけるフェデレーテッドラーニング（Federated Learning, FL）を実装しています。Flower（FL）フレームワークとPyTorchを使用し、U-Netモデルをベースとしたセグメンテーションを行います。クライアント間でモデルの重みを共有し、中央サーバーで集約することで、データを共有することなく分散学習を可能にしています。

## ディレクトリ構成

```
├── data
│   ├── dataset.py        # データセットのロードと前処理
├── models
│   ├── unet.py           # U-Netモデルの実装
├── strategies
│   ├── base_strategy.py  # カスタム戦略の実装
├── client.py             # クライアント側の処理
├── run.py                # 実行スクリプト
├── requirements.txt      # 必要なパッケージ
└── README.md             # 説明書（本ファイル）
```

## 必要条件

- Python 3.8以上
- PyTorch 1.7以上
- Flower
- その他のライブラリは `requirements.txt` を参照

## インストール

仮想環境を作成し、必要なパッケージをインストールします。

```bash
# 仮想環境の作成（任意）
python -m venv fl_env
source fl_env/bin/activate  # Windowsの場合は fl_env\Scripts\activate

# パッケージのインストール
pip install -r requirements.txt
```

## データセットの準備

1. **データセットの取得**

   - Kvasir-SEGデータセットをダウンロードします。
   - [Kvasir-SEGデータセット](https://datasets.simula.no/kvasir-seg/)

2. **データの配置**

   - データを以下のディレクトリ構造になるように配置します。

     ```
     data/
     └── kvasir-seg/
         ├── images/
         │   ├── image1.jpg
         │   ├── image2.jpg
         │   └── ...
         └── masks/
             ├── mask1.jpg
             ├── mask2.jpg
             └── ...
     ```

3. **データの前処理**

   - 必要に応じて `data/dataset.py` 内のパスや前処理を調整してください。

## 使い方

### 1. クライアントの設定

- `client.py` には、クライアント側の処理が定義されています。
- クライアントごとのデータローダーやモデルの初期化、学習・評価ロジックが含まれています。

### 2. サーバーの設定

- `strategies/base_strategy.py` にて、モデルの集約戦略や評価指標の集計方法を定義しています。

### 3. シミュレーションの実行

- `run.py` スクリプトを使用して、FLのシミュレーションを実行します。

```bash
python run.py --strategy [STRATEGY_NAME] --gpu
```

- `--strategy`：使用する戦略名を指定します（例：`FedAvg`、`SOFA`）。
- `--gpu`：GPUを使用する場合に指定します。

**例：**

```bash
python run.py --strategy FedAvg --gpu
```

### 4. パラメータの調整

- 学習率やエポック数、バッチサイズなどのハイパーパラメータは、`client.py` 内で調整できます。
- クライアント数やラウンド数などの設定は、`run.py` や `strategies/base_strategy.py` で調整してください。

## 評価指標

以下の評価指標を使用して、モデルの性能を評価します。

- **Dice Score**：モデルの予測と実際のマスクとの重なり具合を評価。
- **Precision**：正しく検出された前景ピクセルの割合。
- **Recall**：実際の前景ピクセルの中で正しく検出された割合。
- **Accuracy**：全ピクセルに対する正解率。
- **IoU (Intersection over Union)**：予測マスクと実際のマスクの重なりの割合。

## 注意事項

- **データのシャッフル**：テストデータローダーではシャッフルを有効にしています。再現性が必要な場合は、シードの固定を検討してください。
- **ハイパーパラメータの調整**：モデルの性能を向上させるために、ハイパーパラメータを適宜調整してください。
- **リソースの使用**：クライアント数やデータサイズが大きい場合、計算資源の消費が増加します。GPUやメモリの使用状況に注意してください。

## トラブルシューティング

- **エラーが発生する場合**：
  - エラーメッセージを確認し、該当箇所のコードやデータの設定を見直してください。
  - 必要に応じて、依存関係のバージョンを確認し、`requirements.txt` を更新してください。

- **評価指標が変化しない場合**：
  - モデルが適切に学習しているか確認してください。
  - 学習率やエポック数を調整し、データのシャッフルや乱数シードの設定を見直してください。

## ライセンス

このプロジェクトは、MITライセンスの下で公開されています。

## 貢献

バグ報告や機能追加の提案など、貢献を歓迎します。GitHubのリポジトリでIssueやPull Requestを作成してください。

## 連絡先

- 作成者：**Ryo Shimano**
- E-mail：**e1j21027[at]st.oit.ac.jp**

---

ご利用いただきありがとうございます。ご不明な点や問題がございましたら、お気軽にお問い合わせください。
